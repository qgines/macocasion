<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Productos | Macocasion</title>
<style>
:root{--bg:#f5f5f7;--card:#fff;--text:#1d1d1f;--muted:#6e6e73;--line:#d2d2d7;--accent:#000}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#fff,var(--bg));color:var(--text)}
a{color:inherit;text-decoration:none}
.container{width:min(1100px,92vw);margin:0 auto}
header{position:sticky;top:0;background:rgba(255,255,255,.82);backdrop-filter:saturate(180%) blur(14px);border-bottom:1px solid var(--line);z-index:10}
.bar{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:16px 0;flex-wrap:wrap}
.logo{height:56px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:14px}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{padding:28px 0 40px}
h1{margin:0;font-size:34px;letter-spacing:-.2px}
.sub{margin:6px 0 0;color:var(--muted);font-size:15px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:18px}
.card{background:var(--card);border:1px solid rgba(210,210,215,.55);border-radius:22px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.06);cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
.card:hover{transform:translateY(-3px);box-shadow:0 18px 44px rgba(0,0,0,.10)}
.img{height:170px;background:linear-gradient(180deg,#ffffff,#f0f0f2);padding:14px}
.img img{width:100%;height:100%;object-fit:cover;border-radius:16px;border:1px solid rgba(210,210,215,.6);background:#fff}
.body{padding:16px 16px 18px}
.title{font-weight:700;font-size:16px}
.row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px}
.price{font-size:20px;font-weight:800}
.muted{color:var(--muted);font-size:12px}

/* Modal galería */
#pModal{position:fixed;inset:0;z-index:2000;display:none}
#pModal.open{display:block}
#pModal .pm-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
#pModal .pm-card{
  position:relative;width:min(980px,92vw);
  margin:min(6vh,40px) auto;background:#fff;
  border:1px solid rgba(210,210,215,.6);border-radius:22px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);padding:16px;
}
#pModal .pm-x{
  position:absolute;right:12px;top:10px;width:40px;height:40px;border-radius:999px;
  border:1px solid rgba(210,210,215,.8);background:#fff;cursor:pointer;font-size:22px;line-height:36px;
}
#pModal .pm-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
#pModal .pm-imgWrap{position:relative}
#pModal .pm-img{width:100%;height:360px;object-fit:cover;border-radius:18px;border:1px solid rgba(210,210,215,.7);background:#fff}
#pModal .pm-nav{
  position:absolute;top:50%;transform:translateY(-50%);
  width:44px;height:44px;border-radius:999px;border:1px solid rgba(210,210,215,.8);
  background:rgba(255,255,255,.9);cursor:pointer;font-size:22px;line-height:40px;
}
#pModal .pm-prev{left:10px}
#pModal .pm-next{right:10px}
#pModal .pm-thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
#pModal .pm-thumbs img{
  width:78px;height:58px;object-fit:cover;border-radius:12px;
  border:1px solid rgba(210,210,215,.8);cursor:pointer;opacity:.9
}
#pModal .pm-thumbs img.active{outline:3px solid rgba(0,0,0,.10);opacity:1}
#pModal .pm-title{font-weight:800;font-size:18px;letter-spacing:-.2px}
#pModal .pm-price{font-weight:900;font-size:22px;margin:8px 0 10px}
#pModal .pm-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
#pModal .pm-meta{font-size:12px;margin-top:12px;color:var(--muted)}
@media(max-width:980px){
  .grid{grid-template-columns:repeat(2,1fr)}
  #pModal .pm-grid{grid-template-columns:1fr}
  #pModal .pm-img{height:280px}
}
@media(max-width:560px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><div class="container bar">
  <a href="index.html"><img src="img/logo-macocasion.png" class="logo" alt="Macocasion"></a>
  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <a class="btn" href="legal.html">Legal</a>
    <a class="btn primary" id="waTop" href="#" target="_blank" rel="noopener">WhatsApp</a>
  </div>
</div></header>

<main class="container">
  <h1>MacBooks disponibles</h1>
  <p class="sub">Haz clic en un producto para ver todas las fotos.</p>
  <div id="grid" class="grid"></div>
</main>

<!-- Modal -->
<div id="pModal" aria-hidden="true">
  <div class="pm-backdrop"></div>
  <div class="pm-card" role="dialog" aria-modal="true">
    <button class="pm-x" aria-label="Cerrar">×</button>
    <div class="pm-grid">
      <div class="pm-media">
        <div class="pm-imgWrap">
          <img class="pm-img" alt="">
          <button class="pm-nav pm-prev" aria-label="Anterior">‹</button>
          <button class="pm-nav pm-next" aria-label="Siguiente">›</button>
        </div>
        <div class="pm-thumbs"></div>
      </div>
      <div class="pm-info">
        <div class="pm-title"></div>
        <div class="pm-price"></div>
        <div class="sub pm-desc"></div>
        <div class="pm-actions">
          <a class="btn primary" id="pmBuy" href="#" target="_blank" rel="noopener">Comprar por WhatsApp</a>
          <a class="btn" href="legal.html">Ver condiciones</a>
        </div>
        <div class="pm-meta">Factura · Garantía 1 año · Devolución 15 días · Envío 24/48h</div>
      </div>
    </div>
  </div>
</div>

<script src="js/store.js"></script>
<script>
  (async () => {
    const { config, products, waLink } = await window.MCO_STORE.loadStore();
    const waNum = (config && config.wa_number) ? config.wa_number : "34XXXXXXXXX";
    const wa = (msg)=>waLink(waNum, msg);

    const grid = document.getElementById("grid");
    document.getElementById("waTop").href = wa("Hola, vengo de Macocasion. Quiero información sobre un MacBook de ocasión.");

    const PRODUCTS = products || [];

    // Modal elements
    const modal = document.getElementById("pModal");
    const modalImg = modal.querySelector(".pm-img");
    const modalThumbs = modal.querySelector(".pm-thumbs");
    const modalTitle = modal.querySelector(".pm-title");
    const modalPrice = modal.querySelector(".pm-price");
    const modalDesc = modal.querySelector(".pm-desc");
    const modalBuy = modal.querySelector("#pmBuy");
    const btnPrev = modal.querySelector(".pm-prev");
    const btnNext = modal.querySelector(".pm-next");

    let currentImgs = [];
    let currentIndex = 0;

    function setImg(i){
      if(!currentImgs.length) return;
      currentIndex = (i + currentImgs.length) % currentImgs.length;
      modalImg.src = currentImgs[currentIndex];
      modalThumbs.querySelectorAll("img").forEach((x,idx)=>x.classList.toggle("active", idx===currentIndex));
    }

    function openModal(p){
      modalTitle.textContent = p.title;
      modalPrice.textContent = (Number(p.price)||0).toFixed(0) + " €";
      modalDesc.textContent = p.shortDesc || "";
      modalBuy.href = wa(p.waMsg || "Hola, estoy interesado/a en este MacBook. ¿Sigue disponible?");
      currentImgs = Array.isArray(p.images) ? p.images.filter(Boolean) : [];
      modalThumbs.innerHTML = "";
      currentImgs.forEach((src, idx)=>{
        const t = document.createElement("img");
        t.src = src;
        t.alt = `Foto ${idx+1} - ${p.title}`;
        t.onclick = ()=> setImg(idx);
        modalThumbs.appendChild(t);
      });
      setImg(0);
      modal.classList.add("open");
      modal.setAttribute("aria-hidden","false");
    }

    function closeModal(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden","true");
    }

    modal.querySelector(".pm-backdrop").onclick = closeModal;
    modal.querySelector(".pm-x").onclick = closeModal;
    window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });
    btnPrev.onclick = ()=> setImg(currentIndex - 1);
    btnNext.onclick = ()=> setImg(currentIndex + 1);

    if(!PRODUCTS.length){
      grid.innerHTML = "<p class='muted'>No hay productos cargados.</p>";
      return;
    }

    PRODUCTS.forEach(p=>{
      const cover = (p.images && p.images.find(x=>typeof x === "string" && x.length)) || "";
      const card = document.createElement("article");
      card.className="card";
      card.innerHTML = `
        <div class="img"><img src="${cover}" alt="${p.title}"></div>
        <div class="body">
          <div class="title">${p.title}</div>
          <div class="muted">Estado: ${p.estado} · ${p.batteryCycles} ciclos · ${p.ref}</div>
          <div class="row">
            <div class="price">${Number(p.price).toFixed(0)} €</div>
            <a class="btn primary" href="${wa(p.waMsg || "Hola, estoy interesado/a.")}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Comprar</a>
          </div>
        </div>`;
      card.addEventListener("click",(ev)=>{ if(ev.target.closest("a.btn")) return; openModal(p); });
      grid.appendChild(card);
    });
  })();
</script>
</body>
</html>
